name: Deploy Documentation

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'nix/docs/**'
      - '.github/workflows/docs.yml'
      - 'python/**'
      - 'flake.nix'
      - 'flake.lock'
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., v0.2.1). Leave empty for latest.'
        required: false
        default: ''

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@main

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" && "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="latest"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Build documentation
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          nix-build nix/docs/build-versioned.nix --argstr docsVersion "$VERSION" -o result
          mkdir -p site
          cp -rL result/* site/

      - name: Build latest docs (for release deploys)
        if: steps.version.outputs.version != 'latest'
        run: |
          nix-build nix/docs/build-versioned.nix --argstr docsVersion latest -o result-latest
          mkdir -p site-latest
          cp -rL result-latest/* site-latest/

      - name: Deploy to repx-org.github.io
        env:
          VERSION: ${{ steps.version.outputs.version }}
          DEPLOY_KEY: ${{ secrets.DOCS_DEPLOY_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
          export GIT_SSH_COMMAND="ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no"

          git clone --depth 1 --branch gh-pages \
            git@github.com:repx-org/repx-org.github.io.git deploy-repo || {
            mkdir deploy-repo && cd deploy-repo && git init && git checkout --orphan gh-pages && cd ..
          }

          cd deploy-repo

          if [[ "$VERSION" == "latest" ]]; then
            rm -rf latest
            cp -r ../site latest
          else
            rm -rf "$VERSION"
            cp -r ../site "$VERSION"

            rm -rf latest
            cp -r ../site-latest latest
          fi

          python3 -c "
          import json, os, re
          versions = sorted(
              [e for e in os.listdir('.') if os.path.isdir(e) and re.match(r'^v\d+', e)],
              key=lambda v: [int(x) for x in re.findall(r'\d+', v)],
              reverse=True,
          )
          result = [{'version': 'latest', 'url': '/latest/', 'latest': True}]
          for i, v in enumerate(versions):
              result.append({'version': v, 'url': f'/{v}/', 'latest': i == 0})
          with open('versions.json', 'w') as f:
              json.dump(result, f, indent=2)
          "

          cat > index.html <<'EOF'
          <!DOCTYPE html>
          <html>
            <head>
              <meta charset="utf-8">
              <meta http-equiv="refresh" content="0; url=/latest/">
              <link rel="canonical" href="/latest/">
              <title>RepX Documentation</title>
            </head>
            <body>
              <p>Redirecting to <a href="/latest/">latest documentation</a>...</p>
            </body>
          </html>
          EOF

          touch .nojekyll

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet && echo "No changes to deploy" && exit 0
          git commit -m "docs: deploy $VERSION"
          git push origin gh-pages
